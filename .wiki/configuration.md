# Configuration

## Overview

The application uses a **runtime configuration** approach via `config.json`, allowing deployment-time customization without rebuilding. Configuration is fetched on app startup and drives service initialization, authentication mode, and feature availability.

---

## Configuration File

### Location

- **Source**: `config.example.json` (template, not used at runtime)
- **Runtime**: `/config.json` (served from `public/` or generated by deployment)
- **Build Output**: `dist/config.json` (copied from `public/` or generated in post-provision hook)

### Configuration Schema

**File**: `config.example.json` (full example), `config.authenticated.json`, `config.anonymous.json` (presets)

```json
{
  "name": "API Center Portal",
  "apiCenterAudience": "https://{workspace}.data.azure-apicenter.ms",
  "apiCenterDataPlaneUri": "https://{workspace}.data.azure-apicenter.ms",
  "authentication": {
    "clientId": "{azure-ad-app-client-id}",
    "authority": "https://login.microsoftonline.com/{tenant-id}",
    "redirectUri": "https://{deployed-portal-url}"
  },
  "apiFilters": {
    "lifecycle": ["design", "development", "testing", "production"],
    "kind": ["rest", "graphql", "grpc", "soap"],
    "customProperties": [
      {
        "name": "team",
        "values": ["teamA", "teamB"]
      }
    ]
  },
  "scoping": {
    "workspaceIds": ["{workspace-1}", "{workspace-2}"]
  }
}
```

### Configuration Properties

| Property | Type | Required | Purpose |
|----------|------|----------|---------|
| `name` | string | Yes | Portal display name (shown in header) |
| `apiCenterAudience` | string | Yes | Azure AD token audience for API Center |
| `apiCenterDataPlaneUri` | string | Yes | API Center data plane base URL |
| `authentication` | object | **No** | MSAL configuration (omit for anonymous access) |
| `authentication.clientId` | string | If auth | Azure AD app registration client ID |
| `authentication.authority` | string | If auth | Azure AD authority URL (tenant-specific or common) |
| `authentication.redirectUri` | string | If auth | OAuth redirect URI (must match portal URL) |
| `apiFilters` | object | No | Available filter options in UI |
| `apiFilters.lifecycle` | string[] | No | Lifecycle stage values for filter |
| `apiFilters.kind` | string[] | No | API kind/type values for filter |
| `apiFilters.customProperties` | object[] | No | Custom metadata properties for filter |
| `scoping` | object | No | Multi-workspace support (future) |
| `scoping.workspaceIds` | string[] | No | Restrict portal to specific workspaces |

---

## Configuration Loading

### Fetch Process

**Location**: `src/atoms/configAtom.ts`

**Implementation**:
```typescript
export const configAtom = atom<IConfig | null>({
  key: 'config',
  default: null,
  effects: [
    ({ setSelf }) => {
      fetch('/config.json')
        .then(res => res.json())
        .then(config => setSelf(config))
        .catch(err => {
          console.error('Failed to load config:', err);
          setSelf(null);
        });
    },
  ],
});
```

**Timing**: Fetched on app mount (before any API calls). Services wait for `configAtom` to resolve.

---

## Configuration-Driven Behavior

### 1. Authentication Mode Selection

**Logic**: Presence of `config.authentication` determines mode.

**Implementation** (src/atoms/appServicesAtom.ts):
```typescript
if (config?.authentication) {
  // Authenticated mode → MSAL
  authService = new MsalAuthService(config.authentication);
} else {
  // Anonymous mode → no auth
  authService = new AnonymousAuthService();
}
```

**Impact**:
- **Authenticated**: MSAL initialized, "Sign In" button shown, API calls include `Authorization: Bearer {token}`.
- **Anonymous**: No MSAL, "Sign In" button hidden, API calls have no auth header (requires API Center to allow anonymous access).

### 2. UI Feature Toggling

**Atom**: `isAnonymousAccessEnabledAtom` (selector based on `configAtom`)

**Implementation**:
```typescript
export const isAnonymousAccessEnabledAtom = selector<boolean>({
  key: 'isAnonymousAccessEnabled',
  get: ({ get }) => {
    const config = get(configAtom);
    return !config?.authentication;
  },
});
```

**Usage in Components**:
```tsx
// Header.tsx
const isAnonymous = useRecoilValue(isAnonymousAccessEnabledAtom);
<div className={isAnonymous ? styles.navLinksNoSeparator : styles.navLinks}>
  {!isAnonymous && <AuthBtn />}
</div>

// ApiInfoOptions.tsx
{config.authentication && (
  <Button onClick={openInVsCode}>Open in VS Code</Button>
)}
```

**Features Hidden in Anonymous Mode**:
- "Sign In" button
- Header auth separator border
- "Open in VS Code" buttons (require auth for API Center API calls)

### 3. Filter Options

**Source**: `config.apiFilters` → populates filter dropdowns.

**Fallback**: If `apiFilters` not in config, use defaults from `src/config/apiFilters.ts`.

**Example** (ApiFilters component):
```tsx
const config = useRecoilValue(configAtom);
const lifecycleOptions = config?.apiFilters?.lifecycle || DEFAULT_LIFECYCLE;
```

**Custom Properties**: `config.apiFilters.customProperties` → rendered as additional filter dropdowns.

---

## Environment-Specific Configuration

### Development

**File**: `public/config.json` (local dev file)

**Content**: Points to development API Center instance, localhost redirect URI.

**Example**:
```json
{
  "apiCenterDataPlaneUri": "https://dev-apicenter.data.azure-apicenter.ms",
  "authentication": {
    "clientId": "dev-client-id",
    "redirectUri": "http://localhost:5173"
  }
}
```

### Production (Azure Static Web Apps)

**File**: Generated by `infra/hooks/postprovision.ps1` or `postprovision.sh`.

**Process**:
1. `azd provision` runs Bicep templates → creates API Center, Static Web App.
2. `postprovision` hook runs → reads `azd env` variables.
3. Script generates `config.json` with production values.
4. `azd deploy` uploads `config.json` to Static Web App root.

**Script Snippet** (postprovision.ps1):
```powershell
$config = @{
  apiCenterDataPlaneUri = $env:API_CENTER_DATA_PLANE_URI
  apiCenterAudience = $env:API_CENTER_AUDIENCE
  authentication = @{
    clientId = $env:AZURE_CLIENT_ID
    authority = "https://login.microsoftonline.com/$env:AZURE_TENANT_ID"
    redirectUri = $env:STATIC_WEB_APP_URL
  }
} | ConvertTo-Json

$config | Out-File -FilePath ./dist/config.json
```

### Self-Hosted

**File**: Manually created `config.json` in deployment directory.

**Process**:
1. Copy `config.example.json` to `config.json`.
2. Replace placeholders with actual values (API Center URL, client ID, etc.).
3. Deploy alongside built assets.

---

## Configuration Validation

### Runtime Validation

**Current State**: No explicit validation (TODO).

**Recommended**:
```typescript
function validateConfig(config: unknown): config is IConfig {
  if (!config || typeof config !== 'object') return false;
  if (!config.apiCenterDataPlaneUri || !config.apiCenterAudience) return false;
  // Additional checks...
  return true;
}

// In configAtom effect
if (!validateConfig(config)) {
  console.error('Invalid config:', config);
  setSelf(null);
}
```

### TypeScript Types

**Location**: `src/types/Config.ts` (TODO: verify exact path)

**Interface**:
```typescript
export interface IConfig {
  name: string;
  apiCenterAudience: string;
  apiCenterDataPlaneUri: string;
  authentication?: {
    clientId: string;
    authority: string;
    redirectUri: string;
  };
  apiFilters?: {
    lifecycle?: string[];
    kind?: string[];
    customProperties?: Array<{
      name: string;
      values: string[];
    }>;
  };
  scoping?: {
    workspaceIds?: string[];
  };
}
```

---

## Build-Time vs Runtime Configuration

### Build-Time Configuration

**File**: `vite.config.ts`, `tsconfig.json`, `azure.yaml`

**Purpose**: Build tool settings, TypeScript compiler options, azd configuration.

**Not Exposed to App**: These values are compile-time only (e.g., `base` path, `outDir`).

### Runtime Configuration

**File**: `config.json`

**Purpose**: App behavior, API endpoints, authentication settings.

**Exposed to App**: Fetched by browser at runtime via `/config.json` endpoint.

**Why Runtime?**: Allows same built artifact (`dist/` folder) to be deployed to multiple environments with different configs (dev, staging, prod) without rebuilding.

---

## Environment Variables (azd Deployment)

### azd Environment Variables

**Location**: `.azure/{env-name}/.env` (generated by `azd provision`)

**Key Variables**:
```
AZURE_ENV_NAME=dev
AZURE_LOCATION=eastus
AZURE_SUBSCRIPTION_ID={sub-id}
AZURE_TENANT_ID={tenant-id}
API_CENTER_NAME={generated-name}
API_CENTER_DATA_PLANE_URI={generated-uri}
AZURE_CLIENT_ID={generated-client-id}
STATIC_WEB_APP_URL={generated-url}
```

**Usage**: Post-provision hooks read these to generate `config.json`.

### Accessing azd Variables in Hooks

**PowerShell** (postprovision.ps1):
```powershell
$apiCenterUri = $env:API_CENTER_DATA_PLANE_URI
```

**Bash** (postprovision.sh):
```bash
API_CENTER_URI=$(azd env get-value API_CENTER_DATA_PLANE_URI)
```

---

## Configuration Updates

### Updating Configuration in Deployed App

**Azure Static Web Apps**:
1. Modify `config.json` in Azure portal (Static Web App → Files → Edit).
2. Or re-run `azd deploy` to upload new config.

**App Service**:
1. SSH into App Service or use Azure portal file editor.
2. Edit `/home/site/wwwroot/config.json`.
3. No restart needed (fetched on each page load).

**Self-Hosted**:
1. Edit `config.json` on server.
2. Clear browser cache if already loaded.

---

## Configuration Presets

### config.authenticated.json

**Purpose**: Example for authenticated mode (MSAL).

**Key Feature**: Includes `authentication` object.

**Use Case**: Corporate environments with Azure AD SSO.

### config.anonymous.json

**Purpose**: Example for anonymous mode (no auth).

**Key Feature**: Omits `authentication` object.

**Use Case**: Public developer portals, internal networks with IP restrictions.

### config.example.json

**Purpose**: Template with all possible properties.

**Key Feature**: Includes comments (not valid JSON, but shows intent).

**Use Case**: Copy to `config.json` and customize.

---

## Multi-Workspace Scoping (Future)

### Configuration

```json
{
  "scoping": {
    "workspaceIds": [
      "workspace-1",
      "workspace-2"
    ]
  }
}
```

### Behavior (TODO: Implement)

- Filter API list to only show APIs from specified workspaces.
- Requires API Center to support multi-workspace queries.
- UI may show workspace selector dropdown.

---

## TODO: Configuration

- [ ] Implement config validation on load (type guards, required fields)
- [ ] Verify exact TypeScript interface location (`src/types/Config.ts`?)
- [ ] Document error handling for missing/invalid config (show error page?)
- [ ] Verify if config hot-reloads on change (or requires page refresh)
- [ ] Document Content Security Policy configuration (if CSP restricts fetch())
- [ ] Verify if `apiFilters` defaults exist in `src/config/apiFilters.ts`
- [ ] Document multi-workspace implementation plan (when supported)
- [ ] Verify if environment-specific configs stored in repo (`.gitignore` rules?)
- [ ] Document migration path for config schema changes (backward compatibility)
- [ ] Verify if config cached in localStorage (or always fresh from server)
